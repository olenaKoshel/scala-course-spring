name: Code Verification

on:
  pull_request:
    branches: [ "**" ]

permissions:
  contents: read
  pull-requests: read

jobs:
  branch-naming:
    name: Checking branch naming convention
    runs-on: ubuntu-latest


    steps:
      - name: Checking branch naming convention
        run: |
          if [[ ! ${{ github.head_ref }} =~ ^unit-[0-9]+$ ]]; then
            echo "❌ Naming convention is failed for $GITHUB_HEAD_REF branch."
            exit 1
          fi

  changed-files:
    name: Checking changed files
    runs-on: ubuntu-latest
    needs: branch-naming

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        shell: bash
        run: |
          set -euo pipefail

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Ensure the base commit exists locally (usually does with fetch-depth: 0, but this is safe)
          git fetch --no-tags --prune --depth=1 origin "${BASE_SHA}"

          changed="$(git diff --name-only "${BASE_SHA}" "${HEAD_SHA}")"

          {
            echo "all_changed_files<<EOF"
            echo "${changed}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Ensure changed files belong to this challenge
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        shell: bash
        run: |
          set -euo pipefail

          branch_name='${{ github.head_ref }}'
          package_name="${branch_name//-/}"
          allowed_path="${package_name}/challenge/"

          # Iterate line-by-line (handles multiline output safely)
          while IFS= read -r file; do
            [[ -z "$file" ]] && continue

            if [[ "$file" != *"${allowed_path}"* ]]; then
              echo "❌ $file is outside of $allowed_path folder for $branch_name challenge"
              exit 1
            fi
          done <<< "$ALL_CHANGED_FILES"

      - name: Ensure tests exist for this challenge
        shell: bash
        run: |
          set -euo pipefail
          
          branch_name='${{ github.head_ref }}'
          package_name="${branch_name//-/}"
          allowed_path="${package_name}/challenge"
          
          test_root="src/test"
          
          if [[ ! -d "$test_root" ]]; then
            echo "❌ Tests are requred for $branch_name challenge"
            exit 1
          fi
          
          # Look for any files under src/test/**/$allowed_path/**
          test_files_count="$(find "$test_root" -type f -path "*/${allowed_path}/*" | wc -l | tr -d ' ')"
          
          if [[ "$test_files_count" -eq 0 ]]; then
            echo "❌ Tests are requred for $branch_name challenge"
          fi

  compile:
    runs-on: ubuntu-latest
    needs: branch-naming

    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - uses: olafurpg/setup-scala@v14
        with:
          java-version: openjdk@1.17.0
      - name: Compile main
        run: sbt clean compile
      - name: Compile test
        run: sbt test:compile

  test:
    runs-on: ubuntu-latest
    needs: compile

    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - uses: olafurpg/setup-scala@v14
        with:
          java-version: openjdk@1.17.0
      - name: Run tests
        run: sbt "testOnly $(echo "kse.${{github.head_ref}}.challenge.*" | sed 's/-//g')"

  lint:
    runs-on: ubuntu-latest
    needs: compile

    steps:
      - uses: actions/checkout@v4
      - uses: coursier/cache-action@v6
      - uses: olafurpg/setup-scala@v14
        with:
          java-version: openjdk@1.17.0
      - name: Lint code
        run: sbt scalafmtCheckAll
